<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Auction Site</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <header>
        <h1>Welcome to the NFT Auction Site</h1>
    </header>
    <main>
        <input type="text" id="nftImageUrl" placeholder="IPFS URL of NFT Image" />
        <input type="text" id="nftMetadataUrl" placeholder="IPFS URL of Metadata JSON" />
        <button id="mintButton">Mint NFT and Start Auction</button>
        
        <button id='connectWallet' onclick="">Connect Wallet</button>
        <!-- <button id="mintNFTButton">Mint NFT</button> -->
        <button id="bidButton" style="display: none;">Bid</button>
        <input type="number" id="offerValue" placeholder="Insert an offer" style="display: none;">
        <button id="endauction" style="display: none;">End Auction</button>

        <p id="walletAddress"></p>

        
        <p id = "highestBidTitle" style="display: none;">highest bid</p>
        <!-- 
        <p>highest bidder</p>
        <p id="highestBidder"></p>
        -->
        <p id="highestBid"></p>
        <p id="highestBidder"></p>
        <p id="latestBid"> No Auction Has Been Started</p>
        <p id="finished"></p>


       
        <section>
            <h2>Featured NFTs</h2>
            <!-- NFT items will be listed here -->
            <!-- <div class="nft-item">
                <img src="path_to_nft_image" alt="NFT Image">
                <h3>NFT Title</h3>
                <p>Description of the NFT.</p>
                <a href="#">Place a Bid</a>
            </div> -->
            <div id="nftDisplay">
                <h3 id="nftName"></h3>
                <img id="nftImage" src="" alt="NFT Image">
                <!-- Add other elements as needed -->
            </div>
            <!-- Repeat for other NFTs -->
        </section>
    </main>
    <script>
        let NFTcontract;
        let NFTcontractAddress;
        let AuctioncontractAddress;
        let Auctioncontract;
        let auctionStarted = false;
        let currentNFT = 1;
        // Define the auction owner's address for comparison
        let auctionOwnerAddress = "0x";

        window.addEventListener('load', async () => {
            // Initialize web3
            if (typeof web3 !== 'undefined') {
                window.web3 = new Web3(window.ethereum);
            } else {
                console.log('No web3? You should consider trying MetaMask!');
                window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            }

            let NFTjsonData;
            try {
                let response = await fetch('{{ url_for("static", filename="ABI/mint_nft_abi.json") }}');
                NFTjsonData = await response.json(); // Await the JSON parsing
            } catch (e) {
                console.log(e.message);
                return; // Exit the function if an error occurs
            }
            let AuctionjsonData;
            try {
                let response = await fetch('{{ url_for("static", filename="ABI/auction_abi.json") }}');
                AuctionjsonData = await response.json(); // Await the JSON parsing
            } catch (e) {
                console.log(e.message);
                return; // Exit the function if an error occurs
            }
            NFTcontractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
            AuctioncontractAddress = '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512';
            NFTcontract = new web3.eth.Contract(NFTjsonData, NFTcontractAddress); // Use jsonData here
            Auctioncontract = new web3.eth.Contract(AuctionjsonData, AuctioncontractAddress); // Use jsonData here

            // Start the app
            // mintNFT();
            adjustUIForUserRole();
            if(auctionStarted){
                displayNFT(currentNFT);
            }
            //auction ended
            else{
                document.getElementById('nftDisplay').style.display= 'none';
                document.getElementById('bidButton').style.display= 'none';
                document.getElementById('offerValue').style.display= 'none';
                document.getElementById('highestBidTitle').style.display= 'none';

                highestBid.innerText = "There is no auction at the moment"
                console.log("qui");
            }
            // displayhighestBid();
        });

        async function endedAuction(){
            var result = false;
            await Auctioncontract.getPastEvents("AuctionTerminated",{
                fromBlock:"earliest",
                // toBlock:"latest"
            }, function(error, events){ console.log("errore"); })
            .then(function(events){
                if(events.length !=0){
                    result=true;
                }
            });
            return result;
        }

        async function endAuction(){
            // Check if the user's wallet address is set
            // console.log(window.userWalletAddress);
            // 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
            if (window.userWalletAddress == "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266".toLowerCase()) {
                
                Auctioncontract.methods.finalizeAuction().send({from:window.userWalletAddress})
                    .on('receipt', async (receipt) => {
                        console.log('Auction Bid. Transaction Receipt:', receipt);
                        displayhighestBid();
                    })
                    .on('error', error => {
                        console.error('Error bidding the auction:', error);
                    });
            }
            else{
                console.log("only the creator can end the auction")
            };
        }
        async function displayhighestBid(){
            // console.log("pending transactions",await web3.getPendingTransactions());
            
            var hbid = await Auctioncontract.methods.highestBid().call();
            console.log("hbid",hbid);
            highestBid.innerText = await web3.utils.fromWei(hbid, "ether");
            var hbidder = await Auctioncontract.methods.highestBidder().call();
            // console.log(hbidder);
            // console.log(window.userWalletAddress);
            if (hbidder.toLowerCase() == window.userWalletAddress.toLowerCase()){
                highestBidder.innerText = "you are winning the auction";
            }else{
                highestBidder.innerText="you are not the highest bidder";
            }
            // read the events
            latestBid.innerText = "the auction has not started yet";
            Auctioncontract.events.allEvents({
                fromBlock: "earliest"
            },)
            .on('data', function(event){
                if(event.event == "AuctionStarted"){

                    console.log("AuctionstartedEvent");
                    latestBid.innerText= "you can now place your bid";
                    auctionStarted = true;

                }

                if(event.event == "BidPlaced" && event.returnValues.bidder.toLowerCase()==window.userWalletAddress ){
                    console.log("bidplacedEvent");
                    latestBid.innerText= "";

                }else if(event.event == "BidPlaced" && event.returnValues.bidder.toLowerCase()!=window.userWalletAddress ){
                    console.log("qui");
                    console.log(event.event,event.returnValues.bidder)
                    latestBid.innerText= "your previous bid was refounded";                    
                };


                if(event.event == "AuctionTerminated"){
                    console.log("asta finita");
                    console.log(event)
                    let winner = event.returnValues.winner;
                    let contract = event.returnValues.nftContract;
                    let tokenId = event.returnValues.tokenId;
                    if (winner.toLowerCase() == window.userWalletAddress){
                        highestBidder.innerText = "Congratulations you won the NFT\n NFTaddress: "+contract+" \n TokenID: "+tokenId;
                    }
                    document.getElementById('bidButton').style.display= 'none';

                }
                console.log("evento",event.event,event);
            });  
        };
        //bids for the auction
        async function bid(){
            // Check if the user's wallet address is set
            if (!window.userWalletAddress) {
                return errorMetamask();
            }
            var offert = document.getElementById("offerValue").value;

            console.log("offert",offert)
            const bidValue = web3.utils.toWei(offert.toString(), 'ether');
            Auctioncontract.methods.placeBid().send({from: window.userWalletAddress, value: bidValue})
                .on('receipt', async (receipt) => {
                    console.log('Auction Bid. Transaction Receipt:', receipt);
                    displayhighestBid();
                })
                .on('error', async(error) => {
                    console.log("errore");
                    console.error('Error bidding the auction:', error);
                })
        }

        async function mintNFT() {
            const nftMetadataUrl = document.getElementById('nftMetadataUrl').value.trim();
            if (!nftMetadataUrl) {
                console.error('No NFT metadata URL provided');
                return;
            }
            console.log(window.userWalletAddress)
            console.log(nftMetadataUrl)
            // Assuming the `mintNFT` function of your contract takes the metadata URL directly
            NFTcontract.methods.mintNFT(window.userWalletAddress, nftMetadataUrl).send({ from: window.userWalletAddress })
                .on('receipt', async (receipt) => {
                    console.log('Minted NFT. Transaction Receipt:', receipt);

                    currentNFT = await NFTcontract.methods.getCurrentTokenId().call();
                    displayNFT(currentNFT);
                    startAuction(currentNFT);
                })
                .on('error', error => {
                    console.error('Error minting NFT:', error);
                });
        }


        async function displayNFT(tokenId) {
            console.log("Token ID:", tokenId);
            const tokenURI = await NFTcontract.methods.tokenURI(tokenId).call();
            console.log("Token URI:", tokenURI);

            // Function to convert any IPFS URI to a gateway URL
            function convertIPFSToHttpUrl(ipfsUri) {
                const ipfsGatewayPrefix = 'https://silver-traditional-marmoset-57.mypinata.cloud/ipfs/';
                if (ipfsUri.startsWith('ipfs://')) {
                    return ipfsUri.replace('ipfs://', ipfsGatewayPrefix);
                } else if (ipfsUri.startsWith('https://')) {
                    return ipfsUri; // Already an HTTP URL
                }
                // Add more conditions if you have other types of URLs
                return ipfsUri; // Default case, return the original URI
            }

            // Convert the tokenURI to a gateway URL if it's an IPFS link
            const metadataUrl = convertIPFSToHttpUrl(tokenURI);

            try {
                const metadataResponse = await fetch(metadataUrl);
                if (!metadataResponse.ok) {
                    throw new Error('Failed to fetch NFT metadata');
                }
                const metadata = await metadataResponse.json();

                // Convert the image URL in the metadata to a gateway URL if it's an IPFS link
                const imageUrl = convertIPFSToHttpUrl(metadata.image);

                // Use imageUrl and other metadata to display your NFT
                document.getElementById('nftImage').src = imageUrl;
                document.getElementById('nftName').textContent = metadata.name;
                // Handle other metadata as needed
            } catch (error) {
                console.error('Error displaying NFT:', error);
            }
        }

    
        async function startApp() {
            const address = "0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199";
            try {
                const wei = await window.web3.eth.getBalance(address);
                const balance = window.web3.utils.fromWei(wei, 'ether');
                console.log(balance); // Output the balance
            } catch (err) {
                console.error(err); // Handle the error
            }
        }

        //METAMASK
        window.userWalletAddress = null
        const connectWallet = document.getElementById('connectWallet')
        const walletAddress = document.getElementById('walletAddress')
        const walletBalance = document.getElementById('walletBalance')
        

        // document.getElementById('mintNFTButton').addEventListener('click', mintNFT);
        document.getElementById('bidButton').addEventListener('click', bid);
        document.getElementById('endauction').addEventListener('click', endAuction);
        document.getElementById('mintButton').addEventListener('click', mintNFT);


        function errorMetamask(){
            console.log('No connected MetaMask account');
            const popup = document.createElement('div');
            popup.style.position = 'fixed';
            popup.style.bottom = '0';
            popup.style.left = '0';
            popup.style.width = '100%';
            popup.style.backgroundColor = 'red';
            popup.style.color = 'white';
            popup.style.padding = '10px';
            popup.style.textAlign = 'center';
            if (typeof window.ethereum == 'undefined') {
                popup.textContent = 'MetaMask isn\'t installed, please install it';
            }else{
                popup.textContent = 'Connect MetaMask Wallet';
            }

            // Aggiunta del popup al documento
            document.body.appendChild(popup);
            setTimeout(function() {
                popup.remove();
            }, 2000);
            return;
        }

        // async function startAuction(){
        //     document.getElementById('nftDisplay').style.display= 'block';
        //     document.getElementById('bidButton').style.display= 'block';
        //     document.getElementById('offerValue').style.display= 'block';
        //     document.getElementById('highestBidTitle').style.display= 'block';
        // }

        function checkInstalled() {
            if (typeof window.ethereum == 'undefined') {
            // connectWallet.innerText = 'MetaMask isnt installed, please install it'
                connectWallet.classList.remove()
                connectWallet.classList.add()
                connectWallet.addEventListener('click', errorMetamask)
                return false
            }
            connectWallet.addEventListener('click', connectWalletwithMetaMask)
        }

        async function adjustUIForUserRole() {
            
            await Auctioncontract.getPastEvents("AuctionStarted",{
                fromBlock:"earliest",
                // toBlock:"latest"
            }, function(error, events){ console.log("errore"); })
            .then(function(events){
                console.log(events);
                if(events.length !=0){
                    console.log("here")
                    auctionStarted = true;
                }
            });

            console.log("adjusting screen")
            console.log(auctionStarted)
            let hbidder = '0'
            if(auctionStarted){
                hbidder = await Auctioncontract.methods.highestBidder().call();
            }
            const isOwner = window.userWalletAddress === auctionOwnerAddress.toLowerCase();
            
            console.log("here1")
            const isHigestBidder = window.userWalletAddress === hbidder.toLowerCase();
            const isConnected = window.userWalletAddress !=null;
            // console.log("isconnected",isConnected);
            // Adjust UI elements based on the user role
            document.getElementById('bidButton').style.display= auctionStarted && !isOwner && isConnected ? 'block': 'none';
            document.getElementById('offerValue').style.display= auctionStarted && !isOwner && isConnected ? 'block': 'none';
            document.getElementById('highestBidTitle').style.display= auctionStarted && isConnected? 'block': 'none';

            document.getElementById('highestBid').style.display = auctionStarted && isConnected ? 'block' : 'none';
            // document.getElementById('latestBid').style.display = !isOwner && !isHigestBidder ? 'block' : 'none';

            document.getElementById('endauction').style.display = auctionStarted && isOwner ? 'block' : 'none';
            document.getElementById('nftDisplay').style.display= auctionStarted? 'block': 'none';
            // Add or modify other elements as needed for owner
            // For participants, you can either hide or show elements, or modify text/content
            document.getElementById('highestBidder').style.display= isConnected && auctionStarted &&!isOwner? 'block': 'none';

            document.getElementById('nftImageUrl').style.display= isConnected && !auctionStarted? 'block': 'none';
            document.getElementById('nftMetadataUrl').style.display= isConnected && !auctionStarted? 'block': 'none';
            document.getElementById('mintButton').style.display= isConnected && !auctionStarted ? 'block': 'none';
        }

        async function connectWalletwithMetaMask() {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })
            .catch((e) => {
            console.error(e.message)
            return
            })

            if (!accounts) { return }

            window.userWalletAddress = accounts[0]
            //walletAddress.innerText = window.userWalletAddress

            connectWallet.innerText = 'Sign Out'
            connectWallet.removeEventListener('click', connectWalletwithMetaMask)
            setTimeout(() => {
            connectWallet.addEventListener('click', signOutOfMetaMask)
            }, 200)

            adjustUIForUserRole();
            if(auctionStarted){
                displayhighestBid();
            }
        }

        async function startAuction() {
            if (!window.userWalletAddress) {
                console.log('Wallet not connected');
                return;
            }
            // await new Promise(r => setTimeout(r, 10000));

            console.log("start auction")
            // This assumes you have a function in your Auction contract to start the auction, adjust as necessary
            // Example: AuctionContract.methods.startAuction(parameters...).send({from: window.userWalletAddress})
            const minPrice = web3.utils.toWei('2', 'ether'); // Example reserve price, adjust as necessary
            console.log('token:', currentNFT)
            try {
                console.log(NFTcontractAddress)
                await NFTcontract.methods.approve(AuctioncontractAddress, currentNFT);
                const transactionReceipt = await Auctioncontract.methods.begin(NFTcontractAddress, currentNFT, minPrice).send({from: window.userWalletAddress});
                console.log('Auction started successfully:', transactionReceipt);
                auctionStarted = true;
                auctionOwnerAddress = window.userWalletAddress;
                adjustUIForUserRole();
            } catch (error) {
                console.error('Error starting the auction:', error);
            }
        }


        function signOutOfMetaMask() {
            window.userWalletAddress = null;
            adjustUIForUserRole();
            walletAddress.innerText = ''
            connectWallet.innerText = 'Connect Wallet'

            document.getElementById('endauction').style.display = 'none'; // Hide auction end button by default

            connectWallet.removeEventListener('click', signOutOfMetaMask)
            setTimeout(() => {
            connectWallet.addEventListener('click', connectWalletwithMetaMask)
            }, 200  )

        }

        async function checkBalance() {
            let balance = await window.ethereum.request({ method: "eth_getBalance",
                    params: [
                        window.userWalletAddress,
                        'latest'
                        ]
                    }).catch((err)=> {
                        console.log(err)
                })

            console.log(parseFloat((balance) / Math.pow(10,18)))

            walletBalance.innerText = parseFloat((balance) / Math.pow(10,18))
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkInstalled()

            document.getElementById('endauction').style.display = 'none'; // Hide end auction button by default
        })
        //END METAMASK
    </script>
</body>
</html>
